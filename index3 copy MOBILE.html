<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fresh 92.7 — Top 92 Voting</title>
  <!-- Fonts: use Google versions (easy). If you prefer local TTFs, see the guide below. -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Exo+2:wght@300;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Tropical lei palette to match background */
      --fresh-blue:#00c2b3;   /* teal */
      --purple:#ff4fad;       /* hibiscus pink */
      --cyan:#ffd166;         /* sunshine */
      --bg:#0b0b12;           /* fallback */
      --panel:#10121c;        /* cards */
      --muted:#b3b8c2;        /* helper text */
      --text:#ffffff;
    }

    /* Optional: use local fonts instead of Google (drop TTFs next to this file)  
    @font-face{font-family:'Russo One';src:url('RussoOne-Regular.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap}
    @font-face{font-family:'Exo 2';src:url('Exo2-VariableFont_wght.ttf') format('truetype');font-weight:300 900;font-style:normal;font-display:swap}
    */

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Exo 2',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      /* Hawaiian beach backdrop with a subtle dark overlay for readability */
      background:
        linear-gradient(180deg, rgba(5,8,15,.70), rgba(5,8,15,.45)),
        url('https://www.journee-mondiale.com/en/wp-content/uploads/2024/11/msg_01R4J6e5BTseBK6PNsLBfEKC.webp')
          center / cover fixed no-repeat;
      color:var(--text)
    }
    /* No app header bar; logo sits directly over background */
    header{display:none}
    .wrap{max-width:1140px;margin:0 auto;padding:16px}
    .title{display:flex;gap:14px;align-items:center}
    .logo img{height:44px}
    h1{font-family:'Russo One',sans-serif;letter-spacing:.5px;font-size:26px;margin:0}
    h1 small{display:block;font-size:12px;color:var(--muted);font-weight:400}
    .bar{display:grid;grid-template-columns:1fr auto;gap:12px;margin:14px 0}
    .box{
      background:rgba(16,18,28,.72);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px;
      backdrop-filter: blur(6px);
    }
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input[type="text"],input[type="email"],input[type="tel"], select{background:#0f1020;border:1px solid #262a43;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;min-width:220px;min-height:44px}
    label.small{font-size:12px;color:var(--muted)}
    .btn{
      border:0;border-radius:10px;padding:10px 12px;font-weight:700;
      font-family:'Exo 2',sans-serif;letter-spacing:.3px;color:#08211f;
      background:linear-gradient(135deg, var(--fresh-blue), var(--purple));
      cursor:pointer;min-height:44px;touch-action:manipulation
    }
    .btn.secondary{background:rgba(255,255,255,.08);color:var(--text)}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid #2a2d44}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:6px 10px;border-radius:999px;font-size:12px}
    .az{display:grid;grid-template-columns:repeat(auto-fit,minmax(36px,1fr));gap:6px}
    .az button{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#e3e7f0;padding:6px 8px;border-radius:8px;cursor:pointer;font-weight:700;width:100%;min-height:36px;touch-action:manipulation}
    .az button.active{border-color:transparent;color:#0b0b12;background:linear-gradient(135deg, var(--fresh-blue), var(--purple))}
    .az button:disabled{opacity:.35;cursor:not-allowed}
    .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width: 900px){.layout{grid-template-columns:1fr}}
    /* Make A–Z row span the full width */
    .az-wrap{grid-column:1 / -1}
    .az-wrap .controls{margin-bottom:8px}
    .list{max-height:62vh;overflow:auto;border-radius:16px}
    .row{display:grid;grid-template-columns:1fr auto auto;gap:10px;padding:10px 12px;border-bottom:1px solid #1d1f33;align-items:center}
    .row:hover{background:rgba(255,255,255,.04)}
    .row .meta{display:flex;flex-direction:column}
    .song{font-weight:800}
    .artist{color:var(--muted);font-size:12px}
    .row .actions{display:flex;gap:8px;align-items:center}
    .selected{max-height:62vh;overflow:auto}
    .sel-item{display:flex;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid #1d1f33}
    .muted{color:var(--muted)}
    .counter{font-weight:900}
    footer{margin:18px 0;display:flex;flex-wrap:wrap;gap:10px}

    /* Centered overlay logo */
    .overlay-logo{display:flex;justify-content:center;align-items:center;padding:18px 0 6px;position:relative;z-index:3}
    .overlay-logo img{width:min(60vw,560px);height:auto;filter:drop-shadow(0 8px 18px rgba(0,0,0,.45));}

    /* Mobile optimisations */
    @media (max-width: 600px){
      .wrap{padding:12px}
      .overlay-logo{padding:12px 0 0}
      .overlay-logo img{width:min(78vw,360px)}
      .az-wrap .controls{display:grid;grid-template-columns:1fr;gap:8px}
      .az{display:flex;overflow-x:auto;gap:8px;padding-bottom:6px;scroll-snap-type:x mandatory}
      .az button{flex:0 0 auto;min-width:40px;scroll-snap-align:start}
      .list{max-height:58vh}
      .row{grid-template-columns:1fr auto;align-items:start}
      .row .actions{gap:6px}
      .controls{gap:8px}
      .box{padding:12px;border-radius:14px}
      input[type="text"],input[type="email"],input[type="tel"], select{min-width:0;width:100%}
      footer{margin:14px 0}
      #playerWrap{left:12px;right:12px;}
    }

    /* Toast: lightweight "Submitting…" banner */
    #toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(10,12,20,.92);
      color:#fff;
      border:1px solid #2a2d44;
      border-radius:14px;
      padding:10px 14px;
      display:none;
      gap:10px;
      align-items:center;
      z-index:9999;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      transition:opacity .15s ease, transform .15s ease;
      opacity:0;
      pointer-events:none;
    }
    #toast.show{display:flex;opacity:1;transform:translateX(-50%) translateY(0)}
    #toast .dot{width:8px;height:8px;border-radius:50%;background:#79ffe1;animation:bounce .9s infinite ease-in-out}
    #toast .dot:nth-child(2){animation-delay:.12s}
    #toast .dot:nth-child(3){animation-delay:.24s}
    @keyframes bounce{0%,80%,100%{transform:scale(0.8);opacity:.6}40%{transform:scale(1);opacity:1}}

    /* Share card uses your provided 1080x1920 background */
    #shareCard{
      width:1080px;
      height:1920px;
      background:url('Top 92 My 10 Favourites.jpeg') center/cover no-repeat;
      color:#fff;
      padding:400px 160px 260px;
      position:absolute;
      left:-99999px;
      top:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      gap:24px;
    }
    #shareCard ol{
      list-style:none;
      margin:0;
      padding:0;
      width:100%;
      max-width:720px;
      font-size:42px;
      line-height:1.38;
      font-weight:600;
      letter-spacing:.2px;
      text-shadow:0 4px 14px rgba(0,0,0,.55);
    }
    #shareCard ol li{
      margin:0 0 28px;
    }
    #shareCard ol li:last-child{margin-bottom:0}
    #status{font-size:14px;color:var(--muted)}

    /* Spotify mini player */
    #playerWrap{position:fixed;inset:auto 16px 16px 16px;background:#0f0f18;border:1px solid #242842;border-radius:16px;padding:10px;display:none;z-index:9}
    #playerHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px}
    #playerHead .btn{padding:6px 10px;font-weight:700}
    #closePlayer{background:transparent;border:1px solid #2a2d44;color:#fff;border-radius:8px;padding:4px 8px;cursor:pointer}
  </style>
  <!-- External libs for CSV + image capture -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="songs-2025.js"></script>
</head>
<body>
  <!-- Overlay hero logo directly on background -->
  <div class="overlay-logo">
    <img src="Top 92 Logo for Socials.png" alt="Top 92">
  </div>

  <main class="wrap">
    <!-- Search + A–Z at the top under header -->
    <div class="box az-wrap">
      <div class="controls">
        <input id="search" type="text" placeholder="Search by song or artist…"/>
        <select id="viewBy">
          <option value="title">Browse by Title (A–Z)</option>
          <option value="artist">Browse by Artist (A–Z)</option>
        </select>
        <label class="pill">Selected: <span id="count" class="counter">0</span>/10</label>
        <span id="status"></span>
      </div>
      <div id="az" class="az"></div>
    </div>

    <div class="layout">
      <div class="box">
        <div id="list" class="list" role="list"></div>
      </div>
      <div class="box">
        <h3 style="margin:0 0 8px;font-family:'Russo One',sans-serif;letter-spacing:.4px">My selections</h3>
        <p class="muted" style="margin:0 0 10px">Tap Add/Remove to curate exactly 10.</p>
        <div id="selected" class="selected"></div>
      </div>
    </div>
    <footer>
      <div class="muted">Having trouble? Choose 10, and fill Name, Mobile, and Email.</div>
    </footer>
  </main>

  <!-- Contact form moved to the very bottom -->
  <section class="wrap">
    <div class="box">
      <div class="controls" style="gap:8px">
        <input id="name" type="text" placeholder="Full name" required>
        <input id="mobile" type="tel" placeholder="Mobile" required>
        <input id="email" type="email" placeholder="Email (for your share image)" required>
        <button id="submitBtn" class="btn" disabled>Submit my 10 votes</button>
      </div>
      <label class="small">We’ll email your share image and securely store your ballot for tallying.</label>
    </div>
  </section>

  <!-- Hidden share card for html2canvas capture -->
  <div id="shareCard">
    <ol id="shareList" aria-label="Your Top 10 picks"></ol>
  </div>

  <!-- Reusable media player (Spotify / YouTube / SoundCloud) -->
  <div id="playerWrap">
    <div id="playerHead">
      <strong>Preview</strong>
      <span>
        <a id="openExternal" href="#" target="_blank" rel="noopener" style="display:none" class="btn ghost" title="Open externally">Open</a>
        <button id="closePlayer">Close</button>
      </span>
    </div>
    <iframe id="mediaPlayer" style="width:100%;height:152px;border:0;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe>
  </div>

  <script>
    // Configured: Power Automate HTTP trigger for Digital@fresh927.com.au (OK to use in production)
    // ========================
    // CONFIG — replace with your Power Automate HTTP trigger URL
    // ========================
    const THANK_YOU_URL = 'thank-you.html';
    const APPS_SCRIPT_WEB_APP_URL = "https://defaultbfa2e364c3c248798e918c7601a4d4.38.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/f892cde2433e4ec08a61b5635447974e/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-xW5gKIOk_fB-RxCccg-n24LpMuvrWkQCRGVleIA_bk";

    // --- DEBUG LOGGING (temporary) ---
    console.log('[Top92] Trigger URL set to:', APPS_SCRIPT_WEB_APP_URL);
    window.addEventListener('error', e => {
      try { console.error('[Top92] window error:', e.message || e); } catch(_){}
    });
    window.addEventListener('unhandledrejection', e => {
      try { console.error('[Top92] unhandled rejection:', e.reason || e); } catch(_){}
    });
    // --- END DEBUG ---

    // Toast helpers
    const toastEl = document.createElement('div'); // placeholder guard if #toast not yet parsed
    function showToast(msg){
      const t = document.getElementById('toast') || toastEl;
      const txt = document.getElementById('toastText');
      if (txt && msg) txt.textContent = msg;
      if (t && t.classList) { t.classList.add('show'); t.style.display = 'flex'; }
    }
    function hideToast(){
      const t = document.getElementById('toast');
      if (!t) return;
      t.classList.remove('show');
      setTimeout(()=>{ t.style.display='none'; }, 150);
    }

    // ========================
    // DATA — embedded from Excel (with Spotify/YouTube/SoundCloud links)
    // ========================
    let songs = (window.SONGS_2025 || []).slice();

    // Selected map
    const selected = new Map();
    // State
    let currentLetter = 'All';
    let viewBy = 'title';
    let query = '';

    // Elements
    const listEl = document.getElementById('list');
    const selEl  = document.getElementById('selected');
    const countEl= document.getElementById('count');
    const azEl   = document.getElementById('az');
    const searchEl = document.getElementById('search');
    const viewByEl = document.getElementById('viewBy');
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const nameEl = document.getElementById('name');
    const mobileEl = document.getElementById('mobile');
    const emailEl = document.getElementById('email');
    // No fetch button needed — previews come from CSV

    // Build A–Z bar
    function buildAZ(){
      azEl.innerHTML = '';
      const letters = new Set(songs.map(s => (s[viewBy]||'').trim()[0]?.toUpperCase()).filter(Boolean));
      const allBtn = document.createElement('button');
      allBtn.textContent = 'All';
      allBtn.className = 'active';
      allBtn.addEventListener('click', () => { currentLetter='All'; setAZActive(allBtn); renderList(); });
      azEl.appendChild(allBtn);
      'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(ch => {
        const btn = document.createElement('button');
        btn.textContent = ch;
        if (!letters.has(ch)) btn.disabled = true;
        btn.addEventListener('click', () => { currentLetter=ch; setAZActive(btn); renderList(); });
        azEl.appendChild(btn);
      });
    }
    function setAZActive(activeBtn){
      azEl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      activeBtn.classList.add('active');
    }

    // Render list with filters
    function renderList(){
      listEl.innerHTML = '';
      if (!songs.length){
        const n = document.createElement('div');
        n.className='muted'; n.style.padding='16px';
        n.textContent = 'No songs loaded yet. Click “Import CSV” and select your song list.';
        listEl.appendChild(n);
        return;
      }
      const q = query.toLowerCase();
      const filtered = songs.filter(s => {
        const matchesQuery = q ? (`${s.title} ${s.artist}`.toLowerCase().includes(q)) : true;
        const first = (s[viewBy]||'').trim()[0]?.toUpperCase();
        const matchesLetter = (currentLetter==='All') ? true : (first===currentLetter);
        return matchesQuery && matchesLetter;
      }).sort((a,b)=> (a[viewBy]||'').localeCompare(b[viewBy]||''));

      if (!filtered.length){
        const empty = document.createElement('div');
        empty.className='muted'; empty.style.padding='16px';
        empty.textContent='No songs match your filters.';
        listEl.appendChild(empty);
        return;
      }

      filtered.forEach(s => {
        const key = `${s.artist} — ${s.title}`;
        const row = document.createElement('div');
        row.className='row';

        const meta = document.createElement('div');
        meta.className='meta';
        const t = document.createElement('div'); t.className='song'; t.textContent = s.title; meta.appendChild(t);
        const a = document.createElement('div'); a.className='artist'; a.textContent = s.artist; meta.appendChild(a);

        const actions = document.createElement('div');
        actions.className='actions';

        const preview = document.createElement('button');
        preview.className='btn secondary';
        preview.textContent='Preview';
        preview.title='Play preview';
        preview.disabled = !(s.spotify || s.youtube || s.soundcloud);
        preview.addEventListener('click', ()=> openPreview(s));

        const add = document.createElement('button');
        add.className='btn';
        add.textContent = selected.has(key) ? 'Remove' : 'Add';
        add.style.minWidth='92px';
        add.addEventListener('click', ()=> toggleSelect(s));

        actions.appendChild(preview);
        actions.appendChild(add);

        row.appendChild(meta);
        row.appendChild(actions);

        listEl.appendChild(row);
      });
      refreshButtonsEnabled();
    }

    function toggleSelect(song){
      const key = `${song.artist} — ${song.title}`;
      if (selected.has(key)){ selected.delete(key); }
      else {
        if (selected.size >= 10){ alert('You can only select exactly 10 songs. Remove one to add another.'); return; }
        selected.set(key, song);
      }
      updateSelectedUI();
      renderList();
    }

    function updateSelectedUI(){
      selEl.innerHTML='';
      const arr = Array.from(selected.values());
      arr.forEach((s, idx)=>{
        const item = document.createElement('div');
        item.className='sel-item';
        item.innerHTML = `<div><strong>${idx+1}.</strong> ${s.title} <span class="muted">— ${s.artist}</span></div>`;
        const rm = document.createElement('button');
        rm.className='btn ghost';
        rm.textContent='Remove';
        rm.addEventListener('click', ()=>{ selected.delete(`${s.artist} — ${s.title}`); updateSelectedUI(); renderList(); });
        item.appendChild(rm);
        selEl.appendChild(item);
      });
      countEl.textContent = selected.size;
      validateForm();
    }

    function refreshButtonsEnabled(){
      if (selected.size >= 10){
        listEl.querySelectorAll('.row').forEach(row => {
          const meta = row.querySelector('.song');
          const artist = row.querySelector('.artist');
          const key = `${artist.textContent} — ${meta.textContent}`;
          const btns = row.querySelectorAll('.btn');
          const addBtn = btns[btns.length-1];
          if (!selected.has(key)) addBtn.disabled = true; else addBtn.disabled = false;
          addBtn.textContent = selected.has(key) ? 'Remove' : (selected.size>=10 ? 'Full' : 'Add');
        });
      } else {
        listEl.querySelectorAll('.row').forEach(row => {
          const meta = row.querySelector('.song');
          const artist = row.querySelector('.artist');
          const key = `${artist.textContent} — ${meta.textContent}`;
          const btns = row.querySelectorAll('.btn');
          const addBtn = btns[btns.length-1];
          addBtn.disabled = false;
          addBtn.textContent = selected.has(key) ? 'Remove' : 'Add';
        });
      }
    }

    // Search + viewBy handlers
    searchEl.addEventListener('input', e => { query = e.target.value; currentLetter='All'; setAZActive(azEl.querySelector('button')); renderList(); });
    viewByEl.addEventListener('change', e => { viewBy = e.target.value; currentLetter='All'; buildAZ(); renderList(); });

    // Load CSV once on startup
    // No CSV fetch; embedded list ensures visibility on open

    // Spotify preview (single reusable player)
    const playerWrap = document.getElementById('playerWrap');
    const player = document.getElementById('mediaPlayer');
    const openExternal = document.getElementById('openExternal');
    document.getElementById('closePlayer').addEventListener('click', ()=>{ playerWrap.style.display='none'; player.src=''; openExternal.style.display='none'; openExternal.removeAttribute('href'); });
    function normWatchUrl(u){
      // Convert any YouTube URL/embed to a watch URL for external opening
      if (!u) return '';
      const s = String(u).trim();
      const idMatch = s.match(/(?:v=|youtu\.be\/|embed\/)([A-Za-z0-9_-]{6,})/);
      const id = idMatch ? idMatch[1] : '';
      return id ? `https://www.youtube.com/watch?v=${id}` : s;
    }

    function openPreview(song){
      if (!song) return;
      let src = '';
      let height = 152;
      openExternal.style.display = 'none';
      openExternal.removeAttribute('href');
      if (song.spotify){
        let url = song.spotify;
        if (!url.startsWith('http')) url = `https://open.spotify.com/track/${url}`;
        src = url.replace('open.spotify.com/track','open.spotify.com/embed/track') + '?utm_source=generator&theme=0&autoplay=1';
        height = 152;
        // Try to force playback via postMessage after the iframe loads
        player.addEventListener('load', function onLoad(){
          player.removeEventListener('load', onLoad);
          try {
            // poke focus (counts as gesture in some browsers)
            player.focus();
            setTimeout(()=>{
              try{ player.contentWindow.postMessage({ command: 'play' }, '*'); }catch(e){}
              try{ player.contentWindow.postMessage(JSON.stringify({ command: 'play' }), '*'); }catch(e){}
            }, 150);
          } catch(e) { /* noop */ }
        });
        openExternal.textContent = 'Open in Spotify';
        openExternal.href = url;
        openExternal.style.display = 'inline-block';
      } else if (song.youtube){
        let yt = String(song.youtube).trim();
        // If they paste an iframe embed code, extract src
        const srcAttr = yt.match(/src\s*=\s*"([^"]+)"/i);
        if (srcAttr) yt = srcAttr[1];
        const idMatch = yt.match(/(?:v=|youtu\.be\/|embed\/)([A-Za-z0-9_-]{6,})/);
        const id = idMatch ? idMatch[1] : '';
        if (id){
          src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
          height = 315;
          // Provide an external open link for restricted videos
          openExternal.textContent = 'Open on YouTube';
          openExternal.href = normWatchUrl(yt);
          openExternal.style.display = 'inline-block';
        }
      } else if (song.soundcloud){
        const sc = encodeURIComponent(song.soundcloud.trim());
        src = `https://w.soundcloud.com/player/?url=${sc}&auto_play=true&hide_related=true&show_comments=false&visual=false`;
        height = 166;
        openExternal.textContent = 'Open on SoundCloud';
        openExternal.href = song.soundcloud.trim();
        openExternal.style.display = 'inline-block';
      }
      if (!src) return;
      player.setAttribute('allowfullscreen', '');
      player.style.height = height + 'px';
      player.src = src;
      playerWrap.style.display='block';
    }

    // Validation + Submit
    [nameEl, mobileEl, emailEl].forEach(el => el.addEventListener('input', validateForm));
    function validateForm(){
      const ok = selected.size === 10 && nameEl.value.trim() && mobileEl.value.trim() && emailEl.value.trim();
      submitBtn.disabled = !ok;
    }

    submitBtn.addEventListener('click', handleSubmit);

    async function handleSubmit(){
      if (submitBtn.disabled) return;
      const oldBtnText = submitBtn.textContent;
      submitBtn.textContent = 'Sending from Digital@fresh927.com.au…';
      submitBtn.style.opacity = '0.8';
      statusEl.textContent = 'Generating your share image…';
      submitBtn.disabled = true;
      showToast('Submitting your vote… sending from Digital@fresh927.com.au');

      // Build share card list
      const shareList = document.getElementById('shareList');
      shareList.innerHTML = '';
      const picksArr = Array.from(selected.values()).map(s=>`${s.title} — ${s.artist}`);
      picksArr.forEach(text=>{ const li=document.createElement('li'); li.textContent=text; shareList.appendChild(li); });

      // Render image (lighter + faster for mobile)
      const card = document.getElementById('shareCard');
      let dataURL = '';
      try{
        const canvas = await html2canvas(card, { backgroundColor:null, scale:1, useCORS:true, allowTaint:true });
        dataURL = canvas.toDataURL('image/jpeg', 0.92); // much smaller than PNG
      }catch(err){
        console.warn('html2canvas failed; continuing without image', err);
      }

      // Send to Power Automate (stores + emails with attachment)
      if (APPS_SCRIPT_WEB_APP_URL){
        try{
          const payload = {
            name: nameEl.value.trim(),
            mobile: mobileEl.value.trim(),
            email: emailEl.value.trim(),
            picks_json: picksArr,
            imageDataUrl: dataURL,
            ua: navigator.userAgent
          };
          // Fire-and-forget to Power Automate (avoid CORS issues when opened from file://)
          const goThanks = (() => {
            let done = false;
            return () => {
              if (done) return;
              done = true;
              // slight delay lets UI settle on some mobile browsers
              setTimeout(() => {
                try { window.location.replace(THANK_YOU_URL); }
                catch (_) { window.location.href = THANK_YOU_URL; }
              }, 50);
            };
          })();
          console.log('[Top92] POSTing to Power Automate…');
          console.log('[Top92] Payload sample:', { name: payload.name, email: payload.email, picks_count: payload.picks_json?.length, image_len: (payload.imageDataUrl||'').length });
          const sendPromise = fetch(APPS_SCRIPT_WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
          .then(async (res) => {
            console.log('[Top92] Response status:', res.status, res.statusText);
            try { const txt = await res.text(); console.log('[Top92] Response body (text):', txt?.slice(0,300)); } catch(_) {}
          })
          .catch(err => {
            console.error('[Top92] POST error:', err);
          })
          .finally(() => {
            goThanks();
          });
          // extra failsafe in case promises are halted by the browser
          setTimeout(goThanks, 1500);
        }catch(err){
          hideToast();
          submitBtn.textContent = oldBtnText;
          submitBtn.style.opacity = '1';
          submitBtn.disabled = false;
          console.error(err);
          statusEl.textContent = 'We saved your vote, but emailing the image failed. A preview will open — save it manually.';
          const win = window.open(); if (win){ const img=new Image(); img.src=dataURL; win.document.body.style.margin='0'; win.document.body.appendChild(img); }
        }
      } else {
        showToast('Submitting your vote…');
        // Fallback: open the image so the voter can save it
        statusEl.textContent = 'Almost there! We could not send the email because the endpoint is not set. A preview will open — save it.';
        const win = window.open(); if (win){ const img=new Image(); img.src=dataURL; win.document.body.style.margin='0'; win.document.body.appendChild(img); }
        window.location.replace(THANK_YOU_URL);
      }
      // Failsafe: restore button if navigation does not occur
      setTimeout(()=>{
        submitBtn.textContent = oldBtnText;
        submitBtn.style.opacity = '1';
        submitBtn.disabled = false;
        hideToast();
      }, 6000);
    }

    // Init
    buildAZ();
    renderList();
    updateSelectedUI();
  </script>

  <!-- Submitting toast -->
  <div id="toast" role="status" aria-live="polite" aria-atomic="true">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    <span id="toastText">Submitting…</span>
  </div>
</body>
</html>
