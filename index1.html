<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fresh 92.7 — Top 92 Voting</title>
  <!-- Fonts: use Google versions (easy). If you prefer local TTFs, see the guide below. -->
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Exo+2:wght@300;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --fresh-blue:#0082C8;   /* from brand */
      --purple:#8000ff;
      --cyan:#15f4e6;
      --bg:#0b0b12;           /* night bg */
      --panel:#10121c;        /* cards */
      --muted:#b3b8c2;        /* helper text */
      --text:#ffffff;
    }

    /* Optional: use local fonts instead of Google (drop TTFs next to this file)  
    @font-face{font-family:'Russo One';src:url('RussoOne-Regular.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap}
    @font-face{font-family:'Exo 2';src:url('Exo2-VariableFont_wght.ttf') format('truetype');font-weight:300 900;font-style:normal;font-display:swap}
    */

    *{box-sizing:border-box}
    body{margin:0;font-family:'Exo 2',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(10,12,22,.95),rgba(10,12,22,.6));backdrop-filter:blur(6px)}
    .wrap{max-width:1140px;margin:0 auto;padding:16px}
    .title{display:flex;gap:14px;align-items:center}
    .logo img{height:44px}
    h1{font-family:'Russo One',sans-serif;letter-spacing:.5px;font-size:26px;margin:0}
    h1 small{display:block;font-size:12px;color:var(--muted);font-weight:400}
    .bar{display:grid;grid-template-columns:1fr auto;gap:12px;margin:14px 0}
    .box{background:var(--panel);border:1px solid #1d2034;border-radius:16px;padding:14px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input[type="text"],input[type="email"],input[type="tel"], select{background:#0f1020;border:1px solid #262a43;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;min-width:220px}
    label.small{font-size:12px;color:var(--muted)}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:700;font-family:'Exo 2',sans-serif;letter-spacing:.3px;color:#0b0b12;background:var(--fresh-blue);cursor:pointer}
    .btn.secondary{background:#22243a;color:var(--text)}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid #2a2d44}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0f0f18;border:1px solid #272a44;color:var(--text);padding:6px 10px;border-radius:999px;font-size:12px}
    .az{display:flex;flex-wrap:wrap;gap:6px}
    .az button{background:#0f0f18;border:1px solid #23253a;color:#b6bbca;padding:6px 8px;border-radius:8px;cursor:pointer;font-weight:700}
    .az button.active{border-color:var(--fresh-blue);color:#fff}
    .az button:disabled{opacity:.35;cursor:not-allowed}
    .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width: 900px){.layout{grid-template-columns:1fr}}
    .list{max-height:62vh;overflow:auto;border-radius:16px}
    .row{display:grid;grid-template-columns:1fr auto auto;gap:10px;padding:10px 12px;border-bottom:1px solid #1d1f33;align-items:center}
    .row:hover{background:#0f1020}
    .row .meta{display:flex;flex-direction:column}
    .song{font-weight:800}
    .artist{color:var(--muted);font-size:12px}
    .row .actions{display:flex;gap:8px;align-items:center}
    .selected{max-height:62vh;overflow:auto}
    .sel-item{display:flex;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid #1d1f33}
    .muted{color:var(--muted)}
    .counter{font-weight:900}
    footer{margin:18px 0;display:flex;flex-wrap:wrap;gap:10px}

    /* Share card uses your provided 1080x1920 background */
    #shareCard{width:1080px;height:1920px;background:url('Top 92 My 10 Favourites.jpeg') center/cover no-repeat;color:#fff;padding:96px 80px;position:absolute;left:-99999px;top:0;border-radius:0;display:block}
    #shareCard h2{font-family:'Russo One',sans-serif;font-size:84px;letter-spacing:1px;line-height:1.05;margin:0 0 18px;text-shadow:0 2px 10px rgba(0,0,0,.45)}
    #shareCard ol{font-size:40px;line-height:1.4;margin:24px 0 0 0;padding-left:34px;max-width:870px;text-shadow:0 2px 6px rgba(0,0,0,.45)}
    #shareCard ol li{margin:12px 0 24px} /* extra gap for 'blank line' look */
    #status{font-size:14px;color:var(--muted)}

    /* Spotify mini player */
    #playerWrap{position:fixed;inset:auto 16px 16px 16px;background:#0f0f18;border:1px solid #242842;border-radius:16px;padding:10px;display:none;z-index:9}
    #playerHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    #closePlayer{background:transparent;border:1px solid #2a2d44;color:#fff;border-radius:8px;padding:4px 8px;cursor:pointer}
  </style>
  <!-- External libs for CSV + image capture -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <!-- Put your logo image next to this file and keep the filename matching -->
        <div class="logo"><img src="Blue Fresh Transparent.png" alt="Fresh 92.7"></div>
        <h1>FRESH 92.7 — TOP 92 VOTING <small>Pick exactly 10 favourites, then submit to receive your share image via email.</small></h1>
      </div>
      <div class="bar">
        <div class="box">
          <div class="controls">
            <input id="search" type="text" placeholder="Search by song or artist…"/>
            <select id="viewBy">
              <option value="title">Browse by Title (A–Z)</option>
              <option value="artist">Browse by Artist (A–Z)</option>
            </select>
            <label class="pill">Selected: <span id="count" class="counter">0</span>/10</label>
            <!-- CSV import to load your ~250 songs -->
            <button id="importCsv" class="btn secondary">Import CSV</button>
            <input id="csvInput" type="file" accept=".csv" style="display:none" />
            <span id="status"></span>
          </div>
          <div id="az" class="az" style="margin-top:10px"></div>
        </div>
        <div class="box">
          <div class="controls" style="gap:8px">
            <input id="name" type="text" placeholder="Full name" required>
            <input id="mobile" type="tel" placeholder="Mobile" required>
            <input id="email" type="email" placeholder="Email (for your share image)" required>
            <button id="submitBtn" class="btn" disabled>Submit my 10 votes</button>
          </div>
          <label class="small">We’ll email your share image and securely store your ballot for tallying.</label>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">
      <div class="box">
        <div id="list" class="list" role="list"></div>
      </div>
      <div class="box">
        <h3 style="margin:0 0 8px;font-family:'Russo One',sans-serif;letter-spacing:.4px">My selections</h3>
        <p class="muted" style="margin:0 0 10px">Tap Add/Remove to curate exactly 10.</p>
        <div id="selected" class="selected"></div>
      </div>
    </div>
    <footer>
      <div class="muted">Having trouble? Import your CSV, choose 10, and fill name, mobile, and email.</div>
    </footer>
  </main>

  <!-- Hidden share card for html2canvas capture -->
  <div id="shareCard">
    <h2>MY TOP 10</h2>
    <ol id="shareList"></ol>
  </div>

  <!-- Reusable Spotify player -->
  <div id="playerWrap">
    <div id="playerHead"><strong>Preview</strong><button id="closePlayer">Close</button></div>
    <iframe id="spotifyPlayer" style="width:100%;height:152px;border:0;" allow="encrypted-media"></iframe>
  </div>

  <script>
    // ========================
    // CONFIG — fill this with your Google Apps Script Web App URL
    // ========================
    const APPS_SCRIPT_WEB_APP_URL = ""; // e.g. https://script.google.com/macros/s/AKfycb.../exec

    // ========================
    // DATA — start empty; use Import CSV to load your songs
    // ========================
    let songs = []; // expects objects: { title, artist, spotify? }

    // Selected map
    const selected = new Map();
    // State
    let currentLetter = 'All';
    let viewBy = 'title';
    let query = '';

    // Elements
    const listEl = document.getElementById('list');
    const selEl  = document.getElementById('selected');
    const countEl= document.getElementById('count');
    const azEl   = document.getElementById('az');
    const searchEl = document.getElementById('search');
    const viewByEl = document.getElementById('viewBy');
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const nameEl = document.getElementById('name');
    const mobileEl = document.getElementById('mobile');
    const emailEl = document.getElementById('email');
    const csvBtn = document.getElementById('importCsv');
    const csvInput = document.getElementById('csvInput');

    // Build A–Z bar
    function buildAZ(){
      azEl.innerHTML = '';
      const letters = new Set(songs.map(s => (s[viewBy]||'').trim()[0]?.toUpperCase()).filter(Boolean));
      const allBtn = document.createElement('button');
      allBtn.textContent = 'All';
      allBtn.className = 'active';
      allBtn.addEventListener('click', () => { currentLetter='All'; setAZActive(allBtn); renderList(); });
      azEl.appendChild(allBtn);
      'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(ch => {
        const btn = document.createElement('button');
        btn.textContent = ch;
        if (!letters.has(ch)) btn.disabled = true;
        btn.addEventListener('click', () => { currentLetter=ch; setAZActive(btn); renderList(); });
        azEl.appendChild(btn);
      });
    }
    function setAZActive(activeBtn){
      azEl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      activeBtn.classList.add('active');
    }

    // Render list with filters
    function renderList(){
      listEl.innerHTML = '';
      if (!songs.length){
        const n = document.createElement('div');
        n.className='muted'; n.style.padding='16px';
        n.textContent = 'No songs loaded yet. Click “Import CSV” and select your song list.';
        listEl.appendChild(n);
        return;
      }
      const q = query.toLowerCase();
      const filtered = songs.filter(s => {
        const matchesQuery = q ? (`${s.title} ${s.artist}`.toLowerCase().includes(q)) : true;
        const first = (s[viewBy]||'').trim()[0]?.toUpperCase();
        const matchesLetter = (currentLetter==='All') ? true : (first===currentLetter);
        return matchesQuery && matchesLetter;
      }).sort((a,b)=> (a[viewBy]||'').localeCompare(b[viewBy]||''));

      if (!filtered.length){
        const empty = document.createElement('div');
        empty.className='muted'; empty.style.padding='16px';
        empty.textContent='No songs match your filters.';
        listEl.appendChild(empty);
        return;
      }

      filtered.forEach(s => {
        const key = `${s.artist} — ${s.title}`;
        const row = document.createElement('div');
        row.className='row';

        const meta = document.createElement('div');
        meta.className='meta';
        const t = document.createElement('div'); t.className='song'; t.textContent = s.title; meta.appendChild(t);
        const a = document.createElement('div'); a.className='artist'; a.textContent = s.artist; meta.appendChild(a);

        const actions = document.createElement('div');
        actions.className='actions';

        const preview = document.createElement('button');
        preview.className='btn secondary';
        preview.textContent='Preview';
        preview.title='Play 30s preview';
        preview.disabled = !s.spotify;
        preview.addEventListener('click', ()=> openPreview(s.spotify));

        const add = document.createElement('button');
        add.className='btn';
        add.textContent = selected.has(key) ? 'Remove' : 'Add';
        add.style.minWidth='92px';
        add.addEventListener('click', ()=> toggleSelect(s));

        actions.appendChild(preview);
        actions.appendChild(add);

        row.appendChild(meta);
        row.appendChild(actions);

        listEl.appendChild(row);
      });
      refreshButtonsEnabled();
    }

    function toggleSelect(song){
      const key = `${song.artist} — ${song.title}`;
      if (selected.has(key)){ selected.delete(key); }
      else {
        if (selected.size >= 10){ alert('You can only select exactly 10 songs. Remove one to add another.'); return; }
        selected.set(key, song);
      }
      updateSelectedUI();
      renderList();
    }

    function updateSelectedUI(){
      selEl.innerHTML='';
      const arr = Array.from(selected.values());
      arr.forEach((s, idx)=>{
        const item = document.createElement('div');
        item.className='sel-item';
        item.innerHTML = `<div><strong>${idx+1}.</strong> ${s.title} <span class="muted">— ${s.artist}</span></div>`;
        const rm = document.createElement('button');
        rm.className='btn ghost';
        rm.textContent='Remove';
        rm.addEventListener('click', ()=>{ selected.delete(`${s.artist} — ${s.title}`); updateSelectedUI(); renderList(); });
        item.appendChild(rm);
        selEl.appendChild(item);
      });
      countEl.textContent = selected.size;
      validateForm();
    }

    function refreshButtonsEnabled(){
      if (selected.size >= 10){
        listEl.querySelectorAll('.row').forEach(row => {
          const meta = row.querySelector('.song');
          const artist = row.querySelector('.artist');
          const key = `${artist.textContent} — ${meta.textContent}`;
          const btns = row.querySelectorAll('.btn');
          const addBtn = btns[btns.length-1];
          if (!selected.has(key)) addBtn.disabled = true; else addBtn.disabled = false;
          addBtn.textContent = selected.has(key) ? 'Remove' : (selected.size>=10 ? 'Full' : 'Add');
        });
      } else {
        listEl.querySelectorAll('.row').forEach(row => {
          const meta = row.querySelector('.song');
          const artist = row.querySelector('.artist');
          const key = `${artist.textContent} — ${meta.textContent}`;
          const btns = row.querySelectorAll('.btn');
          const addBtn = btns[btns.length-1];
          addBtn.disabled = false;
          addBtn.textContent = selected.has(key) ? 'Remove' : 'Add';
        });
      }
    }

    // Search + viewBy handlers
    searchEl.addEventListener('input', e => { query = e.target.value; currentLetter='All'; setAZActive(azEl.querySelector('button')); renderList(); });
    viewByEl.addEventListener('change', e => { viewBy = e.target.value; currentLetter='All'; buildAZ(); renderList(); });

    // CSV import (expects headers: title, artist, spotify (optional))
    csvBtn.addEventListener('click', ()=> csvInput.click());
    csvInput.addEventListener('change', (e)=>{
      const file = e.target.files[0]; if (!file) return;
      Papa.parse(file, { header:true, skipEmptyLines:true, complete: (res)=>{
        const rows = res.data.map(r=>({
          title: (r.title || r.Title || r.song || r.Song || '').toString().trim(),
          artist: (r.artist || r.Artist || '').toString().trim(),
          spotify: (r.spotify || r.Spotify || r.spotify_url || '').toString().trim()
        })).filter(r=>r.title && r.artist);
        if (!rows.length){ alert('No valid rows found. Ensure CSV has headers: title,artist,(spotify optional)'); return; }
        songs = rows;
        selected.clear();
        updateSelectedUI();
        buildAZ();
        renderList();
        statusEl.textContent = `Imported ${songs.length} songs.`;
      }});
      e.target.value = '';
    });

    // Spotify preview (single reusable player)
    const playerWrap = document.getElementById('playerWrap');
    const player = document.getElementById('spotifyPlayer');
    document.getElementById('closePlayer').addEventListener('click', ()=>{ playerWrap.style.display='none'; player.src=''; });
    function openPreview(url){
      if (!url) return;
      let src = url.includes('open.spotify.com') ? url : `https://open.spotify.com/track/${url}`;
      player.src = src.replace('open.spotify.com/track','open.spotify.com/embed/track') + '?utm_source=generator&theme=0';
      playerWrap.style.display='block';
    }

    // Validation + Submit
    [nameEl, mobileEl, emailEl].forEach(el => el.addEventListener('input', validateForm));
    function validateForm(){
      const ok = selected.size === 10 && nameEl.value.trim() && mobileEl.value.trim() && emailEl.value.trim();
      submitBtn.disabled = !ok;
    }

    submitBtn.addEventListener('click', handleSubmit);

    async function handleSubmit(){
      if (submitBtn.disabled) return;
      statusEl.textContent = 'Generating your share image…';
      submitBtn.disabled = true;

      // Build share card list
      const shareList = document.getElementById('shareList');
      shareList.innerHTML = '';
      const picksArr = Array.from(selected.values()).map(s=>`${s.title} — ${s.artist}`);
      picksArr.forEach(text=>{ const li=document.createElement('li'); li.textContent=text; shareList.appendChild(li); });

      // Render image
      const card = document.getElementById('shareCard');
      const canvas = await html2canvas(card, {backgroundColor:null, scale:2});
      const dataURL = canvas.toDataURL('image/png');

      // Send to your Apps Script (stores + emails with attachment)
      if (APPS_SCRIPT_WEB_APP_URL){
        try{
          const body = new URLSearchParams();
          body.set('name', nameEl.value.trim());
          body.set('mobile', mobileEl.value.trim());
          body.set('email', emailEl.value.trim());
          body.set('picks_json', JSON.stringify(picksArr));
          body.set('imageDataUrl', dataURL);
          body.set('ua', navigator.userAgent);
          await fetch(APPS_SCRIPT_WEB_APP_URL, { method:'POST', body });
          statusEl.textContent = 'Done! Check your email for the image. Thanks for voting.';
        }catch(err){
          console.error(err);
          statusEl.textContent = 'We saved your vote, but emailing the image failed. A preview will open — save it manually.';
          const win = window.open(); if (win){ const img=new Image(); img.src=dataURL; win.document.body.style.margin='0'; win.document.body.appendChild(img); }
        }
      } else {
        // Fallback: open the image so the voter can save it
        statusEl.textContent = 'Almost there! We could not send the email because the endpoint is not set. A preview will open — save it.';
        const win = window.open(); if (win){ const img=new Image(); img.src=dataURL; win.document.body.style.margin='0'; win.document.body.appendChild(img); }
      }
    }

    // Init
    buildAZ();
    renderList();
    updateSelectedUI();
  </script>
</body>
</html>